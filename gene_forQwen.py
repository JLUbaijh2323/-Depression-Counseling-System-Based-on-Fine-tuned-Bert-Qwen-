import pandas as pd
import json
import re
from tqdm import tqdm
import random

def clean_text(text):
    """统一文本清洗逻辑"""
    # 去除所有标签内容
    cleaned = re.sub(r'\[.*?\]', '', str(text))
    # 标准化处理：去首尾空格、转小写、合并连续空格
    return re.sub(r'\s+', ' ', cleaned).strip().lower()

def load_existing_data(csv_path):
    """加载已有标注数据并建立索引"""
    df = pd.read_csv(csv_path)
    text_map = {}
    for _, row in df.iterrows():
        # 生成标准化文本作为键
        key = clean_text(row['text'])
        # 存储完整数据结构
        text_map[key] = {
            'S2': row['S2'],
            'S3': row['S3'],
            'S9': row['S9'],
            '自然现象隐喻': row['自然现象隐喻'],
            '机械故障隐喻': row['机械故障隐喻'],
            '空间压迫隐喻': row['空间压迫隐喻'],
            '建议文本': row['建议文本']
        }
    return text_map

# 定义更丰富的多样化建议模板
suggestion_templates = {
    # 单一症状建议
    (1, 0, 0, 0, 0, 0): [
        "情绪低落时，去参加一场热闹的聚会，和朋友们尽情欢笑，或许能让你忘却烦恼。",
        "尝试做一些烘焙，看着美味的点心在烤箱中慢慢成型，会给你带来成就感。",
        "阅读一本励志的书籍，从书中汲取力量，重新点燃生活的热情。",
        "去做一次志愿者活动，帮助他人会让你感受到自己的价值。",
        "报名参加一个兴趣班，如绘画、舞蹈，在学习新技能中转移注意力。",
        "养一只小宠物，它的陪伴会给你带来温暖和快乐。"
    ],
    (0, 1, 0, 0, 0, 0): [
        "睡眠障碍困扰着你，晚上可以用薰衣草精油泡个脚，舒缓神经。",
        "制定一个严格的睡眠时间表，每天按时上床睡觉和起床，养成良好的睡眠习惯。",
        "在卧室里放置一些助眠的香薰蜡烛，营造温馨的睡眠氛围。",
        "睡前半小时避免使用电子设备，让眼睛和大脑得到充分休息。",
        "尝试听一些轻柔的助眠音乐，如古典音乐、自然音效，帮助你放松身心。",
        "白天适当进行一些有氧运动，如游泳，能让你晚上更容易入睡。"
    ],
    (0, 0, 1, 0, 0, 0): [
        "自杀倾向是极其危险的，立刻拨打心理危机干预热线，和专业人员倾诉。",
        "写一封给自己的信，把内心的痛苦和想法都写下来，然后试着去分析和面对。",
        "参加一些户外活动，如登山，在挑战自我的过程中重新找到生活的勇气。",
        "和家人一起观看一部温馨的电影，感受家庭的温暖和支持。",
        "记录下生活中让你感到幸福的瞬间，当情绪低落时拿出来看看。",
        "培养一种信仰，它能在你迷茫时给予你精神上的寄托。"
    ],
    (0, 0, 0, 1, 0, 0): [
        "出现自然现象隐喻相关感受时，去山顶看一场日出，感受大自然的壮丽与希望。",
        "在暴风雨过后，去户外呼吸清新的空气，闻一闻泥土的芬芳。",
        "收集一些树叶、花瓣，制作成一幅美丽的拼贴画，感受大自然的色彩。",
        "参加一次观鸟活动，观察鸟儿的生活，感受生命的活力。",
        "在花园里种上一些鲜花，看着它们绽放，会让你心情愉悦。",
        "去海边听海浪的声音，让大海带走你的烦恼。"
    ],
    (0, 0, 0, 0, 1, 0): [
        "机械故障隐喻提醒你检查生活，学习一些简单的机械维修知识，如修理自行车。",
        "整理你的电子设备，清理内存，让它们运行得更顺畅。",
        "给家里的电器做一次全面的检查和保养，确保它们正常工作。",
        "参加一个手工制作机械模型的活动，锻炼你的动手能力。",
        "分析自己生活中的“故障点”，如时间管理问题，制定改进计划。",
        "学习一些编程知识，感受逻辑和秩序的魅力。"
    ],
    (0, 0, 0, 0, 0, 1): [
        "空间压迫隐喻让你感到压抑，把房间的墙壁刷成明亮的颜色，改变空间氛围。",
        "使用一些镜子来增加空间的通透感，让房间看起来更宽敞。",
        "去露营，在广阔的大自然中感受自由和开阔。",
        "在房间里安装一些可以折叠的家具，节省空间。",
        "尝试一些瑜伽的伸展动作，在有限的空间里舒展身体。",
        "定期打开衣柜和抽屉，整理物品，让空间更整洁。"
    ],
    # 两项症状组合建议
    (1, 1, 0, 0, 0, 0): [
        "情绪低落加上睡眠障碍，每天早上进行一段冥想，开启积极的一天。",
        "睡前做一些简单的瑜伽放松动作，既能助眠又能缓解情绪。",
        "和朋友一起去做一次温泉疗养，放松身心，改善睡眠和情绪。",
        "尝试写一首诗歌，把内心的情感用文字表达出来。",
        "参加一个户外瑜伽班，在大自然中舒展身体，调整情绪。",
        "制作一个梦想板，把自己的目标和愿望写在上面，激励自己。"
    ],
    (1, 0, 1, 0, 0, 0): [
        "情绪低落和自杀倾向并存，定期参加心理辅导课程，学习应对情绪的方法。",
        "和家人一起制定一个快乐清单，一起去完成上面的事情。",
        "参加一个艺术治疗小组，通过绘画、音乐等方式释放情绪。",
        "设定一个短期的旅行计划，去一个陌生的地方放松心情。",
        "学习一些放松技巧，如深呼吸、渐进性肌肉松弛法。",
        "养一盆绿植，看着它生长，感受生命的力量。"
    ],
    (0, 1, 1, 0, 0, 0): [
        "睡眠障碍和自杀倾向同时出现，建立一个安全网，让家人朋友随时了解你的情况。",
        "睡前进行一些温和的按摩，放松肌肉，提高睡眠质量。",
        "参加一个睡眠研究小组，了解更多改善睡眠的方法。",
        "尝试芳香疗法，用一些具有安神作用的精油来改善睡眠。",
        "制定一个每日感恩清单，每天晚上睡觉前写下三件让你感恩的事情。",
        "阅读一些关于心理健康的书籍，增强自我认知。"
    ],
    (1, 0, 0, 1, 0, 0): [
        "情绪低落和自然现象隐喻相关，在雨中漫步，让雨水冲刷掉你的烦恼。",
        "去森林中徒步，感受树木的气息，与大自然融为一体。",
        "参加一个园艺课程，学习种植花草，感受生命的成长。",
        "在雪天堆一个雪人，找回童年的乐趣。",
        "观看一场流星雨，许下美好的愿望。",
        "去草原上骑马，感受自由和奔放。"
    ],
    (1, 0, 0, 0, 1, 0): [
        "情绪低落和机械故障隐喻相关，修理一件旧物，赋予它新的生命。",
        "学习一些机械原理知识，了解事物的运行规律。",
        "参加一个科技展览，感受科技的魅力和创新。",
        "拆解一个废旧的电子产品，了解其内部结构。",
        "自己组装一台电脑，提升动手能力和成就感。",
        "阅读一些关于科技发展的书籍，拓宽视野。"
    ],
    (1, 0, 0, 0, 0, 1): [
        "情绪低落和空间压迫隐喻相关，重新布置房间的灯光，营造温馨的氛围。",
        "去图书馆的阅览室，在安静的空间里阅读书籍。",
        "参加一个密室逃脱游戏，挑战自我，突破空间的限制。",
        "在阳台上搭建一个小花园，打造属于自己的小天地。",
        "使用虚拟现实设备，体验不同的空间场景。",
        "去电影院看一场电影，沉浸在大屏幕的世界里。"
    ],
    (0, 1, 0, 1, 0, 0): [
        "睡眠障碍和自然现象隐喻相关，在月光下散步，放松身心。",
        "在卧室里挂一幅自然风景的画，营造舒适的睡眠环境。",
        "在睡前听一段海浪声的音频，帮助你入睡。",
        "参加一个自然摄影课程，用镜头记录美好的瞬间。",
        "在花园里搭建一个小帐篷，晚上在帐篷里睡觉。",
        "去湖边钓鱼，享受宁静的时光。"
    ],
    (0, 1, 0, 0, 1, 0): [
        "睡眠障碍和机械故障隐喻相关，睡前听一些机械运转的平稳声音，如钟表的滴答声。",
        "检查卧室的电器设备，确保它们不会影响你的睡眠。",
        "学习一些简单的电路知识，自己修理一些小电器。",
        "参加一个科技手工制作活动，提高动手能力。",
        "把卧室的闹钟换成静音的电子闹钟。",
        "使用智能睡眠监测设备，了解自己的睡眠情况。"
    ],
    (0, 1, 0, 0, 0, 1): [
        "睡眠障碍和空间压迫隐喻相关，把卧室的床换一个位置，改变空间布局。",
        "在卧室里安装一个星空投影仪，营造浪漫的睡眠氛围。",
        "去空旷的操场躺下来，仰望星空，放松身心。",
        "使用空气净化器，改善卧室的空气质量。",
        "在卧室里放置一些绿植，增加氧气含量。",
        "参加一个空间设计课程，学习如何优化空间。"
    ],
    (0, 0, 1, 1, 0, 0): [
        "自杀倾向和自然现象隐喻相关，去海边看日落，感受生命的美好。",
        "参加一个自然保护志愿者活动，为大自然贡献自己的力量。",
        "在暴风雨中感受大自然的力量，学会坚强。",
        "去山上看云海，感受大自然的神奇。",
        "在森林里露营，与大自然亲密接触。",
        "观看一部关于大自然的纪录片，感受生命的多样性。"
    ],
    (0, 0, 1, 0, 1, 0): [
        "自杀倾向和机械故障隐喻相关，学习一些机械发明的故事，感受人类的创造力。",
        "参加一个科技创业讲座，了解科技改变生活的力量。",
        "修理一辆旧自行车，让它重新上路。",
        "学习编程，开发一个简单的小程序。",
        "参加一个机器人制作比赛，挑战自我。",
        "阅读一些关于科技进步的历史书籍，增强信心。"
    ],
    (0, 0, 1, 0, 0, 1): [
        "自杀倾向和空间压迫隐喻相关，去山顶大喊，释放内心的压力。",
        "参加一个户外拓展训练，挑战空间的限制。",
        "在房间里安装一个天窗，让阳光照进来。",
        "去体育馆参加一场体育比赛，释放能量。",
        "学习一些空间利用的技巧，让房间更宽敞。",
        "去空旷的广场放风筝，感受自由。"
    ],
    (0, 0, 0, 1, 1, 0): [
        "自然现象隐喻和机械故障隐喻相关，观察自然现象中的物理原理，如水流带动水车。",
        "参加一个科技与自然融合的展览，了解创新的力量。",
        "制作一个太阳能小风扇，感受科技与自然的结合。",
        "学习一些关于气象仪器的知识，了解自然现象的监测。",
        "参加一个生态科技研讨会，拓宽视野。",
        "在花园里安装一个自动灌溉系统。"
    ],
    (0, 0, 0, 1, 0, 1): [
        "自然现象隐喻和空间压迫隐喻相关，在暴风雨后去空旷的田野感受清新的空气。",
        "在房间里挂一幅大海的画，让自己仿佛置身于广阔的空间。",
        "参加一个户外写生活动，在自然中寻找灵感。",
        "使用望远镜观察星空，感受宇宙的浩瀚。",
        "在阳台上搭建一个观星台。",
        "去沙漠旅行，感受广袤的空间。"
    ],
    (0, 0, 0, 0, 1, 1): [
        "机械故障隐喻和空间压迫隐喻相关，重新规划房间的收纳空间，提高空间利用率。",
        "参加一个智能家居体验活动，感受科技对空间的优化。",
        "安装一个可折叠的书桌，节省空间。",
        "学习一些机械设计的软件，设计自己的空间方案。",
        "参加一个迷你机械模型展览，感受精致的空间设计。",
        "把房间的旧家具换成多功能家具。"
    ],
    # 三项症状组合建议
    (1, 1, 1, 0, 0, 0): [
        "情绪低落、睡眠障碍和自杀倾向同时出现，立即寻求专业心理医生的全面治疗。",
        "建立一个24小时的陪伴机制，让家人或朋友随时在身边。",
        "严格遵循医生的治疗方案，包括药物治疗和心理辅导。",
        "参加一个互助小组，和有相同经历的人互相鼓励。",
        "每天进行适量的运动，如散步，改善身心状态。",
        "保持规律的饮食，摄入营养丰富的食物。"
    ],
    (1, 1, 0, 1, 0, 0): [
        "情绪低落、睡眠障碍和自然现象隐喻相关，在清晨去公园听鸟儿的歌声，开启美好的一天。",
        "在卧室里放置一个小型的喷泉，聆听流水声助眠。",
        "参加一个自然疗愈工作坊，学习与自然连接的方法。",
        "在花园里设置一个冥想角落，每天进行冥想。",
        "去海边度假，享受阳光和海浪。",
        "种植一些夜间开花的植物，感受夜晚的宁静。"
    ],
    (1, 1, 0, 0, 1, 0): [
        "情绪低落、睡眠障碍和机械故障隐喻相关，睡前听一些机械运转的白噪音，如风扇声。",
        "学习一些智能家居的设置方法，让生活更便捷。",
        "修理一台旧的留声机，感受复古的魅力。",
        "参加一个科技睡眠产品的体验活动。",
        "给卧室的电器设备做一次全面的升级。",
        "制作一个简易的机械闹钟。"
    ],
    (1, 1, 0, 0, 0, 1): [
        "情绪低落、睡眠障碍和空间压迫隐喻相关，把卧室的墙壁贴上有空间感的壁纸。",
        "使用可升降的床，节省卧室空间。",
        "去酒店开一个豪华套房，体验宽敞的空间。",
        "在卧室里安装一个旋转书架，增加收纳空间。",
        "参加一个空间美学课程，提升空间感知能力。",
        "把卧室的窗户换成落地窗。"
    ],
    (1, 0, 1, 1, 0, 0): [
        "情绪低落、自杀倾向和自然现象隐喻相关，去森林中进行一次静修，与自然深度连接。",
        "参加一个自然摄影比赛，用镜头记录生命的美好。",
        "在山顶上搭建一个小木屋，感受大自然的宁静。",
        "去海边看海豚表演，感受生命的活力。",
        "参加一个自然探险活动，挑战自我。",
        "在花园里建造一个小池塘，养一些小鱼。"
    ],
    (1, 0, 1, 0, 1, 0): [
        "情绪低落、自杀倾向和机械故障隐喻相关，学习一些机器人编程知识，感受科技的魅力。",
        "参加一个科技发明大赛，激发创造力。",
        "修理一辆旧摩托车，让它重新轰鸣。",
        "阅读一些关于科技改变命运的书籍。",
        "参加一个科技创业者的分享会。",
        "自己组装一个智能音箱。"
    ],
    (1, 0, 1, 0, 0, 1): [
        "情绪低落、自杀倾向和空间压迫隐喻相关，去跳伞，挑战空间的极限。",
        "参加一个高空玻璃栈道体验活动。",
        "在房间里安装一个大镜子，增加空间的视觉效果。",
        "去空旷的机场看飞机起飞，感受自由和希望。",
        "学习一些空间心理学知识，了解空间对情绪的影响。",
        "在房间里设置一个小型的健身房。"
    ],
    (0, 1, 1, 1, 0, 0): [
        "睡眠障碍、自杀倾向和自然现象隐喻相关，在月光下的海边散步，放松身心。",
        "参加一个自然睡眠疗法的课程，学习利用自然元素改善睡眠。",
        "在卧室里放置一些自然材质的装饰品，如木质摆件。",
        "去森林中露营，听着虫鸣入睡。",
        "观看一场天文奇观，感受宇宙的神秘。",
        "在花园里建造一个小型的天文台。"
    ],
    (0, 1, 1, 0, 1, 0): [
        "睡眠障碍、自杀倾向和机械故障隐喻相关，睡前使用智能按摩仪放松身体。",
        "学习一些电子睡眠辅助设备的使用方法。",
        "参加一个科技与心理健康的研讨会。",
        "修理一台旧的按摩椅。",
        "使用智能手环监测睡眠质量。",
        "参加一个科技康复产品的体验活动。"
    ],
    (0, 1, 1, 0, 0, 1): [
        "睡眠障碍、自杀倾向和空间压迫隐喻相关，在房间里安装一个星空顶，营造梦幻的睡眠环境。",
        "参加一个太空模拟体验活动。",
        "把卧室的床换成榻榻米，节省空间。",
        "去太空馆参观，感受宇宙的浩瀚。",
        "学习一些空间减压的技巧，如深呼吸。",
        "在房间里设置一个小型的瑜伽空间。"
    ],
    (1, 1, 1, 1, 0, 0): [
        "情绪低落、睡眠障碍、自杀倾向和自然现象隐喻相关，立即寻求专业心理帮助，同时去自然环境中疗养。",
        "参加一个自然心理疗愈营，在自然中恢复身心健康。",
        "每天在花园里待一段时间，感受植物的生命力。",
        "去山区的疗养院住一段时间，享受清新的空气。",
        "学习一些自然疗法，如芳香疗法、水疗法。",
        "在自然环境中进行冥想和瑜伽练习。"
    ],
    (1, 1, 1, 0, 1, 0): [
        "情绪低落、睡眠障碍、自杀倾向和机械故障隐喻相关，寻求专业心理医生和科技专家的联合帮助。",
        "参加一个科技心理健康的康复项目。",
        "使用智能睡眠监测和调节设备。",
        "学习一些科技放松技巧，如虚拟现实放松。",
        "参加一个科技与心理融合的研讨会。",
        "尝试使用脑电波监测设备了解自己的心理状态。"
    ],
    (1, 1, 1, 0, 0, 1): [
        "情绪低落、睡眠障碍、自杀倾向和空间压迫隐喻相关，寻求专业心理支持，同时改善居住空间。",
        "参加一个空间心理调适的课程。",
        "重新装修房间，打造一个舒适、开阔的空间。",
        "去开阔的风景区旅行，如大草原。",
        "学习一些空间设计和心理调节的知识。",
        "在房间里安装一个空气循环系统，改善空间氛围。"
    ],
    (1, 1, 0, 1, 1, 0): [
        "情绪低落、睡眠障碍、自然现象隐喻和机械故障隐喻相关，结合自然和科技改善生活状态。",
        "参加一个科技与自然融合的生活方式体验活动。",
        "使用太阳能充电的小夜灯，营造温馨的睡眠环境。",
        "在花园里安装一个智能灌溉系统。",
        "学习一些自然科技的知识，如气象监测设备的使用。",
        "制作一个自然科技主题的手工制品。"
    ],
    (1, 1, 0, 1, 0, 1): [
        "情绪低落、睡眠障碍、自然现象隐喻和空间压迫隐喻相关，在自然中寻找开阔空间，改善睡眠和情绪。",
        "去郊外的田园住一段时间，享受宁静的自然空间。",
        "在房间里放置一些自然风景的立体画。",
        "参加一个自然空间冥想的工作坊。",
        "在阳台上搭建一个自然观景台。",
        "使用虚拟现实设备体验自然的广阔空间。"
    ],
    (1, 1, 0, 0, 1, 1): [
        "情绪低落、睡眠障碍、机械故障隐喻和空间压迫隐喻相关，利用科技优化居住空间，改善睡眠。",
        "参加一个智能家居空间优化的讲座。",
        "安装一个可折叠的智能衣柜。",
        "使用智能窗帘调节光线和空间感。",
        "学习一些空间科技的知识，如空间利用软件。",
        "参加一个科技空间设计的比赛。"
    ],
    (1, 0, 1, 1, 1, 0): [
        "情绪低落、自杀倾向、自然现象隐喻和机械故障隐喻相关，结合科技和自然寻找生活的希望。",
        "参加一个科技自然创新的研讨会。",
        "制作一个自然科技的发明作品。",
        "去科技生态园参观学习。",
        "学习一些自然科技的创新方法。",
        "参加一个自然科技的志愿者活动。"
    ],
    (1, 0, 1, 1, 0, 1): [
        "情绪低落、自杀倾向、自然现象隐喻和空间压迫隐喻相关，在自然和开阔空间中寻找生命的意义。",
        "去沙漠探险，感受自然的广袤和生命的顽强。",
        "参加一个自然空间拓展的训练活动。",
        "在山顶上搭建一个自然观景台。",
        "学习一些自然空间哲学的知识。",
        "去海边的悬崖上感受海风。"
    ],
    (1, 0, 1, 0, 1, 1): [
        "情绪低落、自杀倾向、机械故障隐喻和空间压迫隐喻相关，利用科技突破空间限制，寻找希望。",
        "参加一个科技空间探索的展览。",
        "学习一些空间科技的前沿知识，如太空旅行。",
        "使用虚拟现实设备体验不同的空间。",
        "参加一个科技空间创新的比赛。",
        "设计一个未来空间的模型。"
    ],
    (0, 1, 1, 1, 1, 0): [
        "睡眠障碍、自杀倾向、自然现象隐喻和机械故障隐喻相关，结合科技和自然改善睡眠和心理状态。",
        "参加一个科技自然睡眠改善的项目。",
        "使用自然元素和科技结合的睡眠辅助设备。",
        "在卧室里安装一个智能气象监测仪。",
        "学习一些自然科技睡眠疗法的知识。",
        "制作一个自然科技睡眠的小工具。"
    ],
    (0, 1, 1, 1, 0, 1): [
        "睡眠障碍、自杀倾向、自然现象隐喻和空间压迫隐喻相关，在自然和开阔空间中改善睡眠和心理。",
        "去森林中的树屋住一段时间，享受自然的宁静和开阔空间。",
        "参加一个自然空间睡眠的体验活动。",
        "在房间里安装一个自然风景的投影设备。",
        "学习一些自然空间睡眠的技巧。",
        "在阳台上搭建一个自然睡眠帐篷。"
    ],
    (0, 1, 1, 0, 1, 1): [
        "睡眠障碍、自杀倾向、机械故障隐喻和空间压迫隐喻相关，利用科技优化空间，改善睡眠和心理。",
        "参加一个科技空间睡眠优化的研讨会。",
        "安装一个智能空间调节系统。",
        "使用可移动的智能家具。",
        "学习一些空间科技睡眠的知识。",
        "参加一个科技空间睡眠产品的体验活动。"
    ],
    (1, 1, 1, 1, 1, 0): [
        "情绪低落、睡眠障碍、自杀倾向、自然现象隐喻和机械故障隐喻相关，寻求专业综合治疗，结合科技与自然。",
        "参加一个科技自然心理康复的项目。",
        "使用自然元素和科技结合的康复设备。",
        "在自然环境中进行科技辅助的心理治疗。",
        "学习一些科技自然心理疗法的知识。",
        "参加一个科技自然心理创新的研讨会。"
    ],
    (1, 1, 1, 1, 0, 1): [
        "情绪低落、睡眠障碍、自杀倾向、自然现象隐喻和空间压迫隐喻相关，在自然和开阔空间中接受综合治疗。",
        "去自然疗养院接受专业的心理和身体治疗。",
        "参加一个自然空间心理康复的工作坊。",
        "在自然环境中使用空间拓展的心理训练方法。",
        "学习一些自然空间心理康复的知识。",
        "在自然环境中搭建一个心理康复的小木屋。"
    ],
    (1, 1, 1, 0, 1, 1): [
        "情绪低落、睡眠障碍、自杀倾向、机械故障隐喻和空间压迫隐喻相关，利用科技和空间优化进行综合治疗。",
        "参加一个科技空间心理康复的项目。",
        "使用智能空间和科技结合的康复设备。",
        "在空间优化的环境中进行科技辅助的心理治疗。",
        "学习一些科技空间心理疗法的知识。",
        "参加一个科技空间心理创新的比赛。"
    ],
    (1, 1, 1, 1, 1, 1): [
        "情绪低落、睡眠障碍、自杀倾向、自然现象隐喻、机械故障隐喻和空间压迫隐喻同时出现，立即寻求专业多学科团队的全面治疗。",
        "参加一个综合科技自然空间心理康复的高端项目。",
        "在自然、科技和空间优化的环境中接受全方位的治疗。",
        "学习一些综合科技自然空间心理疗法的知识。",
        "参与一个多学科专家联合的治疗方案。",
        "建立一个全面的康复计划，包括自然疗法、科技辅助和空间调整。"
    ]
}

def get_suggestion(s2, s3, s9, nature_metaphor, mechanical_metaphor, space_metaphor):
    key = (s2, s3, s9, nature_metaphor, mechanical_metaphor, space_metaphor)
    if key in suggestion_templates:
        return random.choice(suggestion_templates[key])
    return "目前没有针对此情况的特定建议，建议保持积极心态，可尝试与他人交流分享感受。"

def process_new_data(input_csv, text_map, output_json):
    """处理新数据并生成JSON"""
    # 读取新数据
    new_df = pd.read_csv(input_csv)
    result = []
    unmatched = 0

    for _, row in tqdm(new_df.iterrows(), total=len(new_df), desc="处理新数据"):
        # 清洗输入文本
        raw_text = row['text']  # 假设新数据列名为text
        cleaned_text = clean_text(raw_text)

        # 查找匹配项
        if cleaned_text in text_map:
            data = text_map[cleaned_text]
            s2 = data['S2']
            s3 = data['S3']
            s9 = data['S9']
            nature_metaphor = data['自然现象隐喻']
            mechanical_metaphor = data['机械故障隐喻']
            space_metaphor = data['空间压迫隐喻']
            suggestion = data['建议文本']
        else:
            s2 = row['S2：情绪低落']
            s3 = row['S3：睡眠障碍']
            s9 = row['S9：自杀倾向']
            nature_metaphor = row['?然现象隐喻']
            mechanical_metaphor = row['机械故障隐喻']
            space_metaphor = row['空间压迫隐喻']
            suggestion = get_suggestion(s2, s3, s9, nature_metaphor, mechanical_metaphor, space_metaphor)

        # 构建案例分析
        symptoms = []
        if s2 == 1:
            symptoms.append("情绪低落")
        if s3 == 1:
            symptoms.append("睡眠障碍")
        if s9 == 1:
            symptoms.append("自杀倾向")
        symptom_str = "、".join(symptoms) if symptoms else "无明显症状"

        metaphors = []
        if nature_metaphor == 1:
            metaphors.append("自然现象隐喻")
        if mechanical_metaphor == 1:
            metaphors.append("机械故障隐喻")
        if space_metaphor == 1:
            metaphors.append("空间压迫隐喻")
        metaphor_str = "、".join(metaphors) if metaphors else "无明显隐喻"

        case_analysis = f"案例分析：患者存在 {symptom_str} 的症状，同时有 {metaphor_str} 的隐喻表达。"

        # 构建回复建议
        reply_suggestion = f"回复建议：{suggestion}"

        # 保留原始文本格式
        input_str = f"[症状:S2={s2},S3={s3},S9={s9}][隐喻:{','.join(metaphors) if metaphors else ''}] {raw_text}"

        result.append({
            "input": input_str,
            "output": {
                "案例分析": case_analysis,
                "回复建议": reply_suggestion
            }
        })

    # 保存结果
    with open(output_json, 'w', encoding='utf-8') as f:
        json.dump(result, f, ensure_ascii=False, indent=2)

    print(f"\n处理完成！匹配成功：{len(result)}条，未匹配：{unmatched}条")
    print(f"输出文件：{output_json}")

if __name__ == "__main__":
    # 配置文件路径
    existing_data_path = "generated_dataset.csv"  # 已有标注数据
    new_data_path = "project_acvice/data/train.csv"  # 新数据路径
    output_path = "output_dataset.json"  # 输出路径

    # 加载已有数据
    print("正在加载已有标注数据...")
    text_mapping = load_existing_data(existing_data_path)

    # 处理新数据
    process_new_data(new_data_path, text_mapping, output_path)